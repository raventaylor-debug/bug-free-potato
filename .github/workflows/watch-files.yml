name: Watch upstream files and notify Slack

on:
  schedule:
    # every 15 minutes (cron uses UTC)
    - cron: "*/15 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write  # allows committing state back into THIS watcher repo

jobs:
  watch:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        watch:
          # TruffleHog example (your file)
          - id: trufflehog_github_go
            repo: trufflesecurity/trufflehog
            branch: main
            path: pkg/detectors/github/v2/github.go

          # Add Gitleaks later by copying this block and changing repo/path:
          # - id: gitleaks_some_file
          #   repo: gitleaks/gitleaks
          #   branch: main
          #   path: path/to/file.ext

    steps:
      - name: Checkout watcher repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute upstream file hash
        id: upstream
        env:
          REPO: ${{ matrix.watch.repo }}
          BRANCH: ${{ matrix.watch.branch }}
          FILE_PATH: ${{ matrix.watch.path }}
        run: |
          set -euo pipefail
          RAW_URL="https://raw.githubusercontent.com/${REPO}/${BRANCH}/${FILE_PATH}"
          curl -fsSL "$RAW_URL" -o upstream_file
          HASH="$(sha256sum upstream_file | awk '{print $1}')"
          echo "raw_url=$RAW_URL" >> "$GITHUB_OUTPUT"
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"

      - name: Read last saved hash
        id: last
        env:
          STATE_FILE: .watch_state/${{ matrix.watch.id }}.sha256
        run: |
          set -euo pipefail
          if [ -f "$STATE_FILE" ]; then
            LAST="$(cat "$STATE_FILE")"
          else
            LAST=""
          fi
          echo "last=$LAST" >> "$GITHUB_OUTPUT"
          echo "state_file=$STATE_FILE" >> "$GITHUB_OUTPUT"

      - name: Notify + update state if changed
        if: steps.upstream.outputs.hash != steps.last.outputs.last
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NEW_HASH: ${{ steps.upstream.outputs.hash }}
          RAW_URL: ${{ steps.upstream.outputs.raw_url }}
          REPO: ${{ matrix.watch.repo }}
          BRANCH: ${{ matrix.watch.branch }}
          FILE_PATH: ${{ matrix.watch.path }}
          STATE_FILE: ${{ steps.last.outputs.state_file }}
        run: |
          set -euo pipefail

          mkdir -p .watch_state
          echo "$NEW_HASH" > "$STATE_FILE"

          FILE_UI_URL="https://github.com/${REPO}/blob/${BRANCH}/${FILE_PATH}"

          payload=$(cat <<EOF
          {
            "text": "ðŸ”” File changed\nâ€¢ Repo: ${REPO}\nâ€¢ File: ${FILE_PATH}\nâ€¢ Branch: ${BRANCH}\nâ€¢ Link: ${FILE_UI_URL}\nâ€¢ Raw: ${RAW_URL}\nâ€¢ New SHA256: ${NEW_HASH}"
          }
          EOF
          )
          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

          git config user.name "repo-watch-bot"
          git config user.email "repo-watch-bot@users.noreply.github.com"
          git add "$STATE_FILE"
          git commit -m "Update watch state: ${REPO}/${FILE_PATH}" || exit 0
          git push
