name: Watch test repo README and notify Slack

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/10 * * * *"  # every 10 minutes (UTC)

permissions:
  contents: write

jobs:
  watch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout watcher repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch upstream file + hash it
        id: upstream
        env:
          RAW_URL: "https://raw.githubusercontent.com/raventaylor-debug/bug-free-potato/main/README.md"
        run: |
          set -euo pipefail
          curl -fsSL "$RAW_URL" -o target_file
          HASH="$(sha256sum target_file | awk '{print $1}')"
          echo "hash=$HASH" >> "$GITHUB_OUTPUT"
          echo "raw_url=$RAW_URL" >> "$GITHUB_OUTPUT"

      - name: Read last saved hash
        id: last
        run: |
          set -euo pipefail
          STATE_FILE=".watch_state/bug_free_potato_readme.sha256"
          if [ -f "$STATE_FILE" ]; then
            LAST="$(cat "$STATE_FILE")"
          else
            LAST=""
          fi
          echo "state_file=$STATE_FILE" >> "$GITHUB_OUTPUT"
          echo "last=$LAST" >> "$GITHUB_OUTPUT"

      - name: Notify + update state if changed (or first run)
        if: steps.upstream.outputs.hash != steps.last.outputs.last
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NEW_HASH: ${{ steps.upstream.outputs.hash }}
          RAW_URL: ${{ steps.upstream.outputs.raw_url }}
        run: |
          set -euo pipefail

          mkdir -p .watch_state
          echo "$NEW_HASH" > "${{ steps.last.outputs.state_file }}"

          FILE_UI_URL="https://github.com/raventaylor-debug/bug-free-potato/blob/main/README.md"

          payload=$(cat <<EOF
          {
            "text": "ðŸ”” README changed in bug-free-potato\nâ€¢ File: ${FILE_UI_URL}\nâ€¢ Raw: ${RAW_URL}\nâ€¢ New SHA256: ${NEW_HASH}"
          }
          EOF
          )

          curl -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"

          git config user.name "repo-watch-bot"
          git config user.email "repo-watch-bot@users.noreply.github.com"
          git add .watch_state/bug_free_potato_readme.sha256
          git commit -m "Update watch state: bug-free-potato README" || exit 0
          git push
